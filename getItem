
function getPeripheral (name)
	for i = 1, #peripheral.getNames() do
		if peripheral.getType(peripheral.getNames()[i]) == name then
			return peripheral.getNames()[i]
		end
	end
	
	return nil
end

local interface = peripheral.wrap(getPeripheral("tileinterface"))
local modem = getPeripheral("modem")
local checkChestId = 0
local interfaceSide = "south"

function openConnection (id)

	local msg = {id = id, cmd = "getFrequency"}
	local i = 0
	local f = 0
	
	rednet.open(modem)
	rednet.send(checkChestId, msg)
	rednet.close(modem)	
	
	while i ~= checkChestId or f == 0 do
		rednet.open(modem)
		i, f = rednet.receive()
		rednet.close(modem)
	end
	
	rednet.open(modem)
	rednet.send(id, f)
	rednet.close(modem)	
	
end

function closeConnection (id)

	local msg = {id = id, cmd = "releaseFrequency"}
	local i = 0
	local bool = false
	
	rednet.open(modem)
	rednet.send(checkChestId, msg)
	rednet.close(modem)
	
	while i ~= checkChestId or bool == false do
		rednet.open(modem)
		i, bool = rednet.receive()
		rednet.close(modem)
	end	
end

function sendItem(itemRequestId, itemName, amount)

	local id = 0
	local msg = false
	
		rednet.open(modem)
		rednet.send(checkChestId, {id = itemRequestId, cmd = "openFrequency"})
		rednet.close(modem)
		
		while not msg or id ~= checkChestId do
			rednet.open(modem)
			id, msg = rednet.receive()
			rednet.close(modem)
			
			if id == checkChestId then
				if not msg then
					os.sleep(5)
					rednet.open(modem)
					rednet.send(checkChestId, {id = itemRequestId, cmd = "openFrequency"})
					rednet.close(modem)
				end
			end
		end
		
		for i = 1, #interface.getAvailableItems() do
			if itemName == interface.getItemDetail(interface.getAvailableItems()[i].fingerprint).basic().display_name then
				if interface.getItemDetail(interface.getAvailableItems()[i].fingerprint).basic().max_size < amount then
					amount = interface.getItemDetail(interface.getAvailableItems()[i].fingerprint).basic().max_size
				end
				interface.exportItem(interface.getAvailableItems()[i].fingerprint, interfaceSide, amount)
			end
		end
			
		
		rednet.open(modem)
		rednet.send(checkChestId, {id = itemRequestId, cmd = "closeFrequency"})
		rednet.close(modem)
		
		while not msg or id ~= checkChestId do
			rednet.open(modem)
			id, msg = rednet.receive()
			rednet.close(modem)
		end
		
		rednet.open(modem)
		rednet.send(itemRequestId, {sent = true, itemName = itemName, amount = amount})
		rednet.close(modem)
	
end
 
function init ()

	print("Initializing")
	os.sleep(5)
	local id = 0
	local msg = ""
	
	rednet.open(modem)
	rednet.broadcast("getItemId")
	rednet.close(modem)
	
	while id == 0 or msg ~= "received" do
		rednet.open(modem)
		id, msg = rednet.receive()
		rednet.close(modem)
	end
	
	checkChestId = id
	
	print("Initialization complete")
end

function shutdown ()

end

function main ()

	init()
	
	while true do
	
		local id = 0
		local msg = {}
		
		rednet.open(modem)
		id, msg = rednet.receive()
		rednet.close(modem)
		
		if type(msg) == "table" then
			if msg.cmd ~= nil then
				if msg.cmd == "openConnection" then
					openConnection(id)
				elseif msg.cmd == "getItem" then
					sendItem(id, msg.itemName, msg.amount)
				elseif msg.cmd == "closeConnection" then
					closeConnection(id)
				end
			end
		elseif msg == "getItemId" then
			rednet.open(modem)
			rednet.send(id, os.getComputerID())
			rednet.close(modem)
		end
	end
	
	shutdown()
end

main()
