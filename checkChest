
function getPeripheral (name)
	for i = 1, #peripheral.getNames() do
		if peripheral.getType(peripheral.getNames()[i]) == name then
			return peripheral.wrap(peripheral.getNames()[i])
		end
	end
end

local chest = getPeripheral("ender_chest")
local frequencies = {}
local modem = getModem("modem")
local getItemId = 0
local homeFrequency = 1
local beginFrequency = 2

function init ()
	
	local id = 0
	local msg = ""
	
	while msg ~= "getItemId" do
		rednet.open(modem)
		id, msg = rednet.receive()
		rednet.close(modem)
	end
	
	rednet.open(modem)
	rednet.send(id, "received")
	rednet.close(modem)
	
	getItemId = id
	
end

function shutdown ()

end

function getFrequency (id)
	
	for i = beginFrequency, #frequencies do
		if not frequencies[i] then
			frequencies[i] = id
			return i
		end
	end
	
	frequencies[#frequencies+1] = id
	
	return #frequencies
end

function releaseFrequency (id)
	for i = beginFrequency, #frequencies do
		if frequencies[i] == id then
			frequencies[i] = nil
			break
		end
	end
end

function setFrequency (id)
	
	for i = beginFrequency, #frequencies do
		if frequencies[i] == id then
			chest.setFrequency(i)
			local a = 0
			local b = ""
			while id == getItemId and a ~= "finished" do
				rednet.open(modem)
				a, b = rednet.receive()
				rednet.close()
				
				if id == getItemId and msg ~= "finished" then
					rednet.open(modem)
					rednet.send(a, "busy")
					rednet.close(modem)
				end
			end
			chest.setFrequency(homeFrequency)
			break
		end
	end
end


function main ()

	init()
	
	while true do

		local id = 0
		local msg = ""
		local f = 0
		
		rednet.open(modem)
		id, msg = rednet.receive()
		rednet.close()
		
		if id == getItemId and msg.cmd = "getFrequency" then
			f = getFrequency(msg.id)
			rednet.open(modem)
			rednet.send(id, f)
			rednet.close(modem)
		elseif id == getItemId and msg.cmd = "releaseFrequency" then
			releaseFrequency(msg.id)
			rednet.open(modem)
			rednet.send(id, "received")
			rednet.close(modem)
		elseif id == getItemId and msg.cmd = "setFrequency" then
			setFrequency(msg.id)
			rednet.open(modem)
			rednet.send(id, "received")
			rednet.close(modem)		
		end
		
		chest.setFrequency(homeFrequency)
		
	end

	shutdown()
end

main()