local reactor = peripheral.wrap("back")
local cycle = 5
local currentMode = "energy"

function getNuclearControlId ()
	local event = ""
	local id = ""
	local msg = ""
	
	rednet.open("bottom")
	while msg ~= "nuclearControl" do
		event, id, msg  = os.pullEvent()
	end
	rednet.send(id, "nuclearControl")
	rednet.close("bottom")
	return id
end

function sendReactorInfo ()

	local reactorInfo = {getHeat = reactor.getHeat(), getMaxHeat = reactor.getMaxHeat(), getEUOutput = reactor.getEUOutput()}
	
	rednet.open("bottom")
	rednet.send(nuclearControlId, reactorInfo)
	rednet.close("bottom")
	
end

local nuclearControlId = getNuclearControlId()

function coolDownMode ()
	redstone.setOutput("back", false)
	redstone.setOutput("right", false)
	redstone.setOutput("top", false)
	redstone.setOutput("left", true)
	return "COOLDOWN"
end

function energyMode ()
	redstone.setOutput("back", true)
	redstone.setOutput("right", false)
	redstone.setOutput("top", true)
	redstone.setOutput("left", false)
	return "ENERGY"
end

function shutDownMode ()
	redstone.setOutput("back", false)
	redstone.setOutput("right", true)
	redstone.setOutput("top", false)
	redstone.setOutput("left", false)
	return "SHUTDOWN"
end

function display (mode)
	term.clear()
	print("Current Temperature: ", reactor.getHeat())
	print("Max Temperature: ", reactor.getMaxHeat())
	print("Shutdown Temperature: ", reactor.getMaxHeat() / 5)
	print("System State: ", mode)
	
end

function setCurrentMode (m)
	
	if m ~= "" then
		currentMode = m
	end
	
	if currentMode == "energy" then
		display(energyMode())
	elseif currentMode == "cooldown" then
		display(coolDownMode())
	elseif currentMode == "shutdown" then
		display(shutDownMode())
	end
	
end

function command (cmd)
	local event = ""
	local id = ""
	local msg = ""
	local m = currentMode
	
	if cmd == "shutdown" then
		
		setCurrentMode("shutdown")
		while msg ~= "start" and id ~= nuclearControlId do
			rednet.open("bottom")
			event, id, msg = os.pullEvent()
			rednet.close("bottom")
		end
		setCurrentMode(m)
		
	elseif cmd == "stop" then
		setCurrentMode("cooldown")
		while wait(cycle) ~= "start" and id ~= nuclearControlId do end
		setCurrentMode(m)
	end	
end

function wait (num)
	local event = ""
	local id = ""
	local msg = ""
	
	if num > 0 then
		os.startTimer(num)
	end

	while true do
		rednet.open("bottom")
		event, id, msg  = os.pullEvent()
		rednet.close("bottom")
		
		if event == "timer" or (event == "rednet_message" and id == nuclearControlId)then
			break
		end
	end
		
	setCurrentMode("")
	sendReactorInfo()
	
	if event == "rednet_message" and id == nuclearControlId then
		command(msg)
		wait(num)
	end
	
	return msg
end


while true do
	local temp = reactor.getHeat()
	local maxTemp = reactor.getMaxHeat()
	local shutDownTemp = maxTemp / 5
	local invSize = reactor.getInventorySize()
	
	setCurrentMode("energy")
	
	-- Lock into cool down mode if  temp is to high until temp is 0
	if temp > shutDownTemp then
		while reactor.getHeat() > 1 do
			setCurrentMode("cooldown")
			wait(cycle)
		end
		setCurrentMode("energy")
	end
	
	for i = 1, invSize do
		local item = reactor.getStackInSlot(i)
		if item ~= nil then
			--Check parts dmg, if any is too high send system into cool down mode
			if item["dmg"]/item["max_dmg"] > .5 and item["name"] ~= "reactorUraniumQuad" then
				while reactor.getStackInSlot(i)["dmg"]/item["max_dmg"] > .05 do
					setCurrentMode("cooldown")
					wait(cycle)
				end
				setCurrentMode("energy")
			end
			
			--Check fuel rod dmg, if dmg is too high shut down 
			if item["dmg"]/item["max_dmg"] > .95 and item["name"] == "reactorUraniumQuad" then
				while reactor.getStackInSlot(i)["dmg"]/item["max_dmg"] > .95 do
					setCurrentMode("shutdown")
					wait(cycle)
				end
				setCurrentMode("energy")
			end
		end
	end
	wait(cycle)
end